# IV- Environnements reproductibles

## Enjeux

- Imaginons la situation suivante :
  - J'installe une version de `R` sur mon poste
  - Je d√©veloppe un projet en installant les _packages_ n√©cessaires
  - Une fois termin√©, je passe au projet suivant, et ainsi de suite.


- Quels [**probl√®mes**]{.orange} puis-je rencontrer au fil des projets ?

- Est-il facile de [**partager**]{.orange} un de mes projets ?

## Enjeux

- [**Version de**]{.orange} [**R**]{.blue2} [**fixe**]{.orange}, celle de l'installation syst√®me


- [**Conflits de version**]{.orange} : diff√©rents projets peuvent requ√©rir diff√©rentes versions d'un m√™me _package_.


- [**Reproductibilit√© limit√©e**]{.orange} : difficile de dire quel projet n√©cessite quel _package_.


- [**Portabilit√© limit√©e**]{.orange} : difficile de pr√©ciser dans un fichier les d√©pendances sp√©cifiques √† un projet.


## Des environnements reproductibles avec `renv`

- `renv` permet de cr√©er des **env**ironnements **r**eproductibles


- [**Isolation**]{.orange} : chaque projet dispose de sa propre librairie de packages


- [**Reproductibilit√©**]{.orange} : `renv` enregistre les versions exactes des *packages* n√©cessaires au projet


- [**Portabilit√©**]{.orange}: un tiers peut ex√©cuter le projet avec les m√™mes sp√©cifications

## Utilisation de `renv`

1. [**Initialisation**]{.orange} (`init`) de l'environnement local du projet


2. [**D√©veloppement**]{.orange} du projet


3. [**Enregistrement**]{.orange} (`snapshot`) des versions des *packages* install√©s


4. [**Restauration**]{.orange} (`restore`) d'un environnement

## :one: Initialisation de l'environnement

- `renv::init()` dans un projet RStudio cr√©e :
  - Un dossier `renv` et le fichier `.Rprofile` : activation automatique de l'environnement
  - Le fichier `renv.lock` : versions des *packages* install√©s

. . .

![](img/renv_init.png){height="400" fig-align="center"}

## :two: D√©veloppement du projet

- Une fois l'environnement initialis√©, on d√©veloppe le projet de mani√®re habituelle :
  - Installations/suppressions/mises √† jour de packages
  - Ecriture de scripts

- `renv::status()` : indique les _packages_ install√©s/supprim√©s par rapport au fichier `renv.lock`

## :three: Enregistrement de l'environnement {.smaller}

- `renv::snapshot()` : enregistre les versions des _packages_ install√©s dans le fichier `renv.lock`

- Ne pas oublier de committer le fichier `renv.lock`!

. . .

![](img/renv_snapshot.png){height="350" fig-align="center"}

## :four: Restauration de l'environnement

- `renv::restore()` : installe/d√©sinstalle les _packages_ n√©cessaires pour arriver √† l'√©tat sp√©cifi√© dans le fichier `renv.lock`


- [**Portabilit√©**]{.orange} : un tiers peut recr√©er un environnement avec les m√™mes sp√©cifications


{{< include applications_r/_application4.qmd >}}


## Vers une reproductibilit√© optimale

- [**Limites**]{.orange} des environnements virtuels : 
  - Les [**librairies syst√®me**]{.blue2} ne sont pas g√©r√©es
  - Lourdeur de la phase d'installation √† chaque changement d'environnement
  - Peu adapt√©s √† un environnement de production


- La [**conteneurisation**]{.orange} (ex : `Docker`) apporte la solution


- [**Intuition**]{.orange} : au lieu de distribuer la recette pour recr√©er l'environnement, [**distribuer directement une "machine" qui contient *tout* l'environnement n√©cessaire au projet**]{.blue2}

## Ressources suppl√©mentaires

- La [documentation officielle de `renv`](https://rstudio.github.io/renv/articles/renv.html)

- La [fiche utilitR sur la gestion des d√©pendances](https://book.utilitr.org/03_Fiches_thematiques/Fiche_gerer_dependances)








# V- `R` en production

## De quoi parle-t-on ?

- [**Production statistique**]{.orange} : chiffres, donn√©es, analyses produits par l'Insee / les SSM

- [**Production informatique**]{.orange} : processus d√©ploy√©s par la DSI sur des [**infrastructures avec "garantie de service"**]{.blue2}

- [**Self de production**]{.orange} : processus d√©ploy√©s sur une [**infra "self"**]{.blue2} contribuant √† la [**production statistique**]{.blue2}

- [**Code de production**]{.orange} : code respectant des [**standards de qualit√©**]{.blue2} qui le rendent [**efficace**]{.blue2} et [**maintenable**]{.blue2}

## `R` : un langage de production ?

- `R` a √©merg√© dans la [**communaut√© statistique**]{.orange}
  - Outils d'[**analyse interactive**]{.blue2} tr√®s d√©velopp√©s
  - Outils de [**d√©veloppement**]{.blue2} limit√©s

- L'[**√©co-syst√®me tidyverse**]{.orange} s'oriente vers des outils [***production-ready***]{.blue2}

. . .

![](img/tidyverse.png){height="250" fig-align="center"}

## Les trois commandements d'Hadley

- Le [**code de production**]{.orange} a trois caract√©ristiques
  - [**"Not just me"**]{.blue2}
  - [**"Not just once"**]{.blue2}
  - [**"Not just my computer"**]{.blue2}

. . .

![](img/hadley.jpg){height="250" fig-align="center"}

## Les trois commandements d'Hadley

::: {.nonincremental}
- Le [**code de production**]{.orange} a trois caract√©ristiques
  - [**"Not just me"**]{.blue2}
  - <span style="color: lightgrey;"><strong>"Not just once"</strong></span>
  - <span style="color: lightgrey;"><strong>"Not just my computer"</strong></span>

![](img/hadley.jpg){height="250" fig-align="center"}
:::

## "Not just me"

- Penser son projet en termes de [**maintenabilit√©**]{.orange}

- Adopter les [**standards communautaires**]{.orange}
  - [**Git**]{.blue2} pour la [**tra√ßabilit√©**]{.blue2} des choix
  - [**Qualit√©**]{.blue2} du code (structure, documentation)
  - Choix des [**packages**]{.blue2} (voir [fiche UtilitR](https://book.utilitr.org/03_Fiches_thematiques/Fiche_comment_choisir_un_package.html))

. . .

::: {style="font-size: 70%; text-align: justify"}
> "Le simple fait qu‚Äôun package fasse (ou semble faire) ce que vous voulez n‚Äôest pas une raison suffisante de l‚Äôutiliser, surtout si votre programme doit rester fonctionnel pendant une longue p√©riode. D√©terminer si on peut utiliser un package revient √† faire un arbitrage entre avantages et inconv√©nients, et √† √©valuer le risque d‚Äôinstabilit√© d‚Äôun package."
>
> [UtilitR](https://book.utilitr.org/03_Fiches_thematiques/Fiche_comment_choisir_un_package.html)
:::

## "Not just me"

- Organiser le [**travail collaboratif**]{.orange}
  - S'accorder sur une [**organisation**]{.blue2}
  - Des outils facilitant via l'[**√©cosyst√®me `Git`**]{.blue2}

- Traiter le code comme un [**√©l√©ment m√©thodologique**]{.orange}
  - [**Revue de code**]{.blue2}

. . .

::: {style="font-size: 70%; text-align: justify"}
> "Les d√©veloppeurs, quel que soit leur r√¥le, y voient de multiples avantages et un contexte dans lequel ils peuvent se former mutuellement, maintenir l'int√©grit√© des bases de code de leurs √©quipes et cr√©er, √©tablir et faire √©voluer des normes qui garantissent la lisibilit√© et la coh√©rence du code."
>
> [Sadowski et al., *Modern Code Review: a Case Study at Google* (2018)](https://dl.acm.org/doi/abs/10.1145/3183519.3183525)
:::

## "Not just me"

- Penser √† l'exp√©rience des [**utilisateurs finaux**]{.orange}

- Pour la mise √† disposition de donn√©es : [Parquet](https://book.utilitr.org/03_Fiches_thematiques/Fiche_import_fichiers_parquet.html)
  - [**Interop√©rable**]{.blue2} et [**m√©ta-donn√©es**]{.blue2} incluses
  - Performances en [**stockage**]{.blue2} et en [**lecture**]{.blue2}

- Pour la documentation / publication : [quarto](https://quarto.org/)
  - Int√®gre [**code**]{.blue2} et [**texte**]{.blue2} pour la [**reproductibilit√©**]{.blue2}
  - Publication [**multi-formats**]{.blue2} (`pdf`, `odt`, `html`)

- Exemple "2 en 1" : [utiliser les donn√©es RP en `Parquet`](https://ssphub.netlify.app/post/parquetrp/)

## Les trois commandements d'Hadley

::: {.nonincremental}
- Le [**code de production**]{.orange} a trois caract√©ristiques
  - <span style="color: lightgrey;"><strong>"Not just me"</strong></span>
  - [**"Not just once"**]{.blue2}
  - <span style="color: lightgrey;"><strong>"Not just my computer"</strong></span>

![](img/hadley.jpg){height="250" fig-align="center"}
:::

## "Not just once"

- Penser son projet en termes de [**reproductibilit√©**]{.orange}

- Une t√¢che de [**production**]{.orange}
  - Est [**r√©p√©t√©e**]{.blue2} dans le temps
  - Peut [**changer d'environnement**]{.blue2} (dev, test, prod...)

- [**Probl√®me**]{.orange} : le monde "autour du code" √©volue
  - [**Sp√©cifier**]{.blue2} et [**contr√¥ler**]{.blue2} l'environnement
  - [**Automatiser**]{.blue2} ce qui peut l'√™tre

## "Not just once"

- Les [**donn√©es**]{.orange} changent
  - [**Factoriser**]{.blue2} le code avec des [**fonctions**]{.blue2}
  - [**Mod√©liser**]{.blue2} sa cha√Æne sous forme de [**DAG**]{.blue2}

. . .

![](img/dag.png){height="250" fig-align="center"}

- Outil : [{targets}](https://books.ropensci.org/targets/)

## "Not just once"

- Le [**code**]{.orange} / les [**donn√©es**]{.orange} changent... et [**cassent**]{.orange}

- Sp√©cifier les [**attendus**]{.orange}
  - [**Tests unitaires**]{.orange} : v√©rifie le bon [**comportement**]{.blue2} du code
  - [**Validation de donn√©es**]{.orange} : v√©rifie l'[**int√©grit√©**]{.blue2} et la [**qualit√©**]{.blue2} des donn√©es

- Outils : [testthat](https://testthat.r-lib.org/) et [pointblank](https://rstudio.github.io/pointblank/)

## "Not just once"

- Les [**d√©pendances**]{.orange} changent (fonctionnalit√©s, *bugs*, failles de s√©curit√©...)

- Arbitrage entre [**√©volutivit√©**]{.orange} et [**stabilit√©**]{.orange}
  - L'[**√©volution des d√©pendances**]{.blue2} est inh√©rente √† la [**maintenance**]{.blue2} d'une cha√Æne de production

- On limite les risques en [**sp√©cifiant l'environnement**]{.orange}
  - [**Fixer**]{.blue2} les versions des packages utilis√©s : [renv](https://rstudio.github.io/renv/articles/renv.html)
  - [**Versionner**]{.blue2} sa cha√Æne de production : tags [Git](https://git-scm.com/doc)

## "Not just once"

- L'[**environnement**]{.orange} change (OS, libs syst√®me, `R`...)
  - Difficult√© principale du [**passage en production**]{.blue2}

- La [**conteneurisation**]{.orange} permet de [**fixer l'environnement**]{.orange}
  - Favorise la [**portabilit√©**]{.blue2}

. . .

![](img/containers-portability.png){height="250" fig-align="center"}

## "Not just once"

- Concevoir sa cha√Æne comme un [***pipeline* de donn√©es**]{.orange}
  - [**Reproductibilit√©**]{.orange} : √©tapes [**int√©gr√©es**]{.blue2} "de bout en bout"
  - [**Stabilit√©**]{.orange} : contr√¥le des [**√©volutions**]{.blue2}
  - [**Portabilit√©**]{.orange} : fluidifie le [**changement d'architecture**]{.blue2}

- Avantage suppl√©mentaire : [**automatisation**]{.orange}

- Outil : [**int√©gration continue**]{.orange} via `GitHub` / `GitLab`
  - Accro√Æt encore les b√©n√©fices d'utiliser `Git` ! 

## Les trois commandements d'Hadley

::: {.nonincremental}
- Le [**code de production**]{.orange} a trois caract√©ristiques
  - <span style="color: lightgrey;"><strong>"Not just me"</strong></span>
  - <span style="color: lightgrey;"><strong>"Not just once"</strong></span>
  - [**"Not just my computer"**]{.blue2}

![](img/hadley.jpg){height="250" fig-align="center"}
:::

## "Not just my computer"

- Evolution continue vers des infrastructures de [**self "*production-ready*"**]{.orange}

. . .

![](img/evo-infra.png){height="400" fig-align="center"}

## "Not just my computer"

- OK, mais pourquoi ü§î ?

- Pourquoi migrer vers des [**infrastructures centralis√©es**]{.orange} ?
  - [**Centralisation**]{.orange} : permet le [**passage √† l'√©chelle**]{.blue2}
  - [**S√©curit√©**]{.orange} : √©vite la [**diss√©mination**]{.blue2} de donn√©es

- Pourquoi migrer vers des [**infrastructures Kubernetes**]{.orange} ?
  - Tout ce qu'on pouvait faire avant... [**en mieux**]{.blue2}
  - [**Nouveaux usages**]{.orange} : d√©ploiements (applications, API), calcul distribu√©, traitements ordonnanc√©s...
  - [**Autonomie**]{.orange} (environnement, stockage, etc.)

## "Not just my computer" {auto-animate=true}

Un point de d√©part commun

![](img/environment_messy.png)

## "Not just my computer" {auto-animate=true}

Un point de d√©part commun ![](img/environment_messy.png){width="10%" fig-align="right"}

Une structuration de projet plus viable

![](img/environment_clean.png)

## "Not just my computer" {auto-animate=true}

Un point de d√©part commun ![](img/environment_messy.png){width="10%" fig-align="right"}

Une structuration de projet plus viable ![](img/environment_clean.png){width="10%" fig-align="right"}

Facilit√©e par [**l'√©co-syst√®me *cloud***]{.orange}

![](img/environment_cloud.png)

## "Not just my computer"
  
- Qu'est-ce qui change ü§î ? 

- [**Techniquement**]{.orange}, tout... ou presque !
  - Du monde [***desktop***]{.blue2} au monde [***server***]{.blue2}
  - Du monde [***Windows***]{.blue2} au monde [***Linux***]{.blue2}

- En pratique, [**Onyxia**]{.orange} facilite la [**transition**]{.orange}

. . .

![](img/onyxia-catalog.png){height="250" fig-align="center"}

## "Not just my computer"

- Qu'est-ce qui change ü§î ?

- [**Monde conteneuris√©**]{.orange} : les traitements sont [**√©ph√©m√®res**]{.orange}
  - "Co√ªt" de l'[**autonomie**]{.blue2} et de la [**mutualisation**]{.blue2} 
  - Mais source de [**reproductibilit√©**]{.blue2} !

. . .

![](img/environment_clean.png){height="300" fig-align="center"}

## "Not just my computer"

- Qu'est-ce qui change ü§î ? 
  - Evolution du [**mode de stockage de donn√©es**]{.orange}

- Infrastructures [**"bureau virtuel"**]{.orange} : [**lecteurs partag√©s**]{.blue2}
  - Le "bureau virtuel" simule le [***filesystem* traditionnel**]{.blue2}

- Infrastructures [**cloud**]{.orange} : [**stockage objet**]{.orange} (`S3` / `MinIO`)
  - Stockage [**tr√®s peu co√ªteux**]{.blue2} 
  - [**Autonomie**]{.orange} : [***bucket***]{.blue2} personnel / de projet
  - [**Fonctionnement diff√©rent**]{.blue2} des *filesystems*

## "Not just my computer"

- Qu'est-ce qui change ü§î ? 

- Evolution de la [**nature des traitements**]{.orange}
  - Traitements [**interactifs**]{.blue2} pour le [**d√©veloppement**]{.blue2}
  - Traitements [**batch**]{.blue2} pour le [**d√©ploiement**]{.blue2}

- Le [**d√©bogage**]{.orange} devient moins imm√©diat
  - N√©cessit√© du [***logging***]{.blue2} : [logger](https://cran.r-project.org/web/packages/logger/vignettes/Intro.html)

## D√©passer le "mur de la production"

- Une organisation limit√©e par l'[**h√©t√©rog√©n√©it√© des environnements**]{.orange}

. . .

![](img/mur-prod.png){height="400" fig-align="center"}

## D√©passer le "mur de la production"

- L'opportunit√© d'organisations [**plus continues**]{.orange}

. . .

![](img/ideal.png){height="450" fig-align="center"}
