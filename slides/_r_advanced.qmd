# IV- Environnements reproductibles

## Enjeux

- Imaginons la situation suivante :
  - J'installe une version de `R` sur mon poste
  - Je d√©veloppe un projet en installant les _packages_ n√©cessaires
  - Une fois termin√©, je passe au projet suivant, et ainsi de suite.


- Quels [**probl√®mes**]{.orange} puis-je rencontrer au fil des projets ?

- Est-il facile de [**partager**]{.orange} un de mes projets ?

## Enjeux

- [**Version de**]{.orange} [**R**]{.blue2} [**fixe**]{.orange}, celle de l'installation syst√®me


- [**Conflits de version**]{.orange} : diff√©rents projets peuvent requ√©rir diff√©rentes versions d'un m√™me _package_.


- [**Reproductibilit√© limit√©e**]{.orange} : difficile de dire quel projet n√©cessite quel _package_.


- [**Portabilit√© limit√©e**]{.orange} : difficile de pr√©ciser dans un fichier les d√©pendances sp√©cifiques √† un projet.


## Des environnements reproductibles avec `renv`

- `renv` permet de cr√©er des **env**ironnements **r**eproductibles


- [**Isolation**]{.orange} : chaque projet dispose de sa propre librairie de packages


- [**Reproductibilit√©**]{.orange} : `renv` enregistre les versions exactes des *packages* n√©cessaires au projet


- [**Portabilit√©**]{.orange}: un tiers peut ex√©cuter le projet avec les m√™mes sp√©cifications

## Utilisation de `renv`

1. [**Initialisation**]{.orange} (`init`) de l'environnement local du projet


2. [**D√©veloppement**]{.orange} du projet


3. [**Enregistrement**]{.orange} (`snapshot`) des versions des *packages* install√©s


4. [**Restauration**]{.orange} (`restore`) d'un environnement

## :one: Initialisation de l'environnement

- `renv::init()` dans un projet RStudio cr√©e :
  - Un dossier `renv` et le fichier `.Rprofile` : activation automatique de l'environnement
  - Le fichier `renv.lock` : versions des *packages* install√©s

. . .

![](img/renv_init.png){height="400" fig-align="center"}

## :two: D√©veloppement du projet

- Une fois l'environnement initialis√©, on d√©veloppe le projet de mani√®re habituelle :
  - Installations/suppressions/mises √† jour de packages
  - Ecriture de scripts

- `renv::status()` : indique les _packages_ install√©s/supprim√©s par rapport au fichier `renv.lock`

## :three: Enregistrement de l'environnement {.smaller}

- `renv::snapshot()` : enregistre les versions des _packages_ install√©s dans le fichier `renv.lock`

- Ne pas oublier de committer le fichier `renv.lock`!

. . .

![](img/renv_snapshot.png){height="350" fig-align="center"}

## :four: Restauration de l'environnement

- `renv::restore()` : installe/d√©sinstalle les _packages_ n√©cessaires pour arriver √† l'√©tat sp√©cifi√© dans le fichier `renv.lock`


- [**Portabilit√©**]{.orange} : un tiers peut recr√©er un environnement avec les m√™mes sp√©cifications


{{< include applications_r/_application4.qmd >}}


## Vers une reproductibilit√© optimale

- [**Limites**]{.orange} des environnements virtuels : 
  - Les [**librairies syst√®me**]{.blue2} ne sont pas g√©r√©es
  - Lourdeur de la phase d'installation √† chaque changement d'environnement
  - Peu adapt√©s √† un environnement de production


- La [**conteneurisation**]{.orange} (ex : `Docker`) apporte la solution


- [**Intuition**]{.orange} : au lieu de distribuer la recette pour recr√©er l'environnement, [**distribuer directement une "machine" qui contient *tout* l'environnement n√©cessaire au projet**]{.blue2}

## Ressources suppl√©mentaires

- La [documentation officielle de `renv`](https://rstudio.github.io/renv/articles/renv.html)

- La [fiche utilitR sur la gestion des d√©pendances](https://book.utilitr.org/03_Fiches_thematiques/Fiche_gerer_dependances)








# V- `R` en production

## De quoi parle-t-on ?

- [**Production statistique**]{.orange} : chiffres, donn√©es, analyses produits par l'Insee / les SSM

- [**Production informatique**]{.orange} : processus maintenus par la [**DSI**]{.blue2} sur des [**infrastructures avec "garantie de service"**]{.blue2}

- [**Self de production**]{.orange} : processus maintenus par le [**m√©tier**]{.blue2} sur une [**infrastructure "self"**]{.blue2}

- [**Code de production**]{.orange} : code respectant des [**standards de qualit√©**]{.blue2} qui le rendent [**efficace**]{.blue2} et [**maintenable**]{.blue2}

## `R` : un langage de production ?

- `R` a √©merg√© dans la [**communaut√© statistique**]{.orange}
  - Outils d'[**analyse interactive**]{.blue2} tr√®s d√©velopp√©s
  - Outils de [**d√©veloppement**]{.blue2} limit√©s

- L'[**√©co-syst√®me tidyverse**]{.orange} s'oriente vers des outils [***production-ready***]{.blue2}

. . .

![](img/tidyverse.png){height="250" fig-align="center"}

## Les trois commandements d'Hadley

- Le [**code de production**]{.orange} a trois caract√©ristiques
  - [**"Not just me"**]{.blue2}
  - [**"Not just once"**]{.blue2}
  - [**"Not just my computer"**]{.blue2}

. . .

![](img/hadley.jpg){height="250" fig-align="center"}

## Les trois commandements d'Hadley

::: {.nonincremental}
- Le [**code de production**]{.orange} a trois caract√©ristiques
  - [**"Not just me"**]{.blue2}
  - <span style="color: lightgrey;"><strong>"Not just once"</strong></span>
  - <span style="color: lightgrey;"><strong>"Not just my computer"</strong></span>

![](img/hadley.jpg){height="250" fig-align="center"}
:::

## "Not just me"

- Penser son projet en termes de [**maintenabilit√©**]{.orange}

- Adopter les [**standards communautaires**]{.orange}
  - [**Git**]{.blue2} pour la [**tra√ßabilit√©**]{.blue2} des choix
  - [**Qualit√©**]{.blue2} du code (structure, documentation)
  - Choix des [**packages**]{.blue2} (voir [fiche UtilitR](https://book.utilitr.org/03_Fiches_thematiques/Fiche_comment_choisir_un_package.html))

. . .

::: {style="font-size: 70%; text-align: justify"}
> "Le simple fait qu‚Äôun package fasse (ou semble faire) ce que vous voulez n‚Äôest pas une raison suffisante de l‚Äôutiliser, surtout si votre programme doit rester fonctionnel pendant une longue p√©riode. D√©terminer si on peut utiliser un package revient √† faire un arbitrage entre avantages et inconv√©nients, et √† √©valuer le risque d‚Äôinstabilit√© d‚Äôun package."
>
> [UtilitR](https://book.utilitr.org/03_Fiches_thematiques/Fiche_comment_choisir_un_package.html)
:::

## "Not just me"

- Organiser le [**travail collaboratif**]{.orange}
  - S'accorder sur une [**organisation**]{.blue2}
  - Des outils facilitant via l'[**√©cosyst√®me `Git`**]{.blue2}

- Traiter le code comme un [**√©l√©ment m√©thodologique**]{.orange}
  - [**Revue de code**]{.blue2}

. . .

::: {style="font-size: 70%; text-align: justify"}
> "Les d√©veloppeurs, quel que soit leur r√¥le, y voient de multiples avantages et un contexte dans lequel ils peuvent se former mutuellement, maintenir l'int√©grit√© des bases de code de leurs √©quipes et cr√©er, √©tablir et faire √©voluer des normes qui garantissent la lisibilit√© et la coh√©rence du code."
>
> Sadowski et al., *Modern code review: a case study at google* (2018)
:::

## "Not just me"

- Penser √† l'exp√©rience des [**utilisateurs finaux**]{.orange}

- Pour la mise √† disposition de donn√©es : [Parquet](https://book.utilitr.org/03_Fiches_thematiques/Fiche_import_fichiers_parquet.html)
  - [**Interop√©rable**]{.blue2} et [**m√©ta-donn√©es**]{.blue2} incluses
  - Performances en [**stockage**]{.blue2} et en [**lecture**]{.blue2}

- Pour la documentation / publication : [quarto](https://quarto.org/)
  - Int√®gre [**code**]{.blue2} et [**texte**]{.blue2} pour la [**reproductibilit√©**]{.blue2}
  - Publication [**multi-formats**]{.blue2} (`pdf`, `odt`, `html`)

- Exemple "2 en 1" : [utiliser les donn√©es RP en `Parquet`](https://ssphub.netlify.app/post/parquetrp/)

## Les trois commandements d'Hadley

::: {.nonincremental}
- Le [**code de production**]{.orange} a trois caract√©ristiques
  - <span style="color: lightgrey;"><strong>"Not just me"</strong></span>
  - [**"Not just once"**]{.blue2}
  - <span style="color: lightgrey;"><strong>"Not just my computer"</strong></span>

![](img/hadley.jpg){height="250" fig-align="center"}
:::

## "Not just once"

- Penser son projet en termes de [**reproductibilit√©**]{.orange}

- Une t√¢che de [**production**]{.orange}
  - Est [**r√©p√©t√©e**]{.blue2} dans le temps
  - Peut [**changer d'environnement**]{.blue2} (dev, test, prod...)

- [**Probl√®me**]{.orange} : le monde "autour du code" √©volue
  - [**Sp√©cifier**]{.blue2} et [**contr√¥ler**]{.blue2} l'environnement
  - [**Automatiser**]{.blue2} ce qui peut l'√™tre

## "Not just once"

- Les [**donn√©es**]{.orange} changent
  - [**Factoriser**]{.blue2} le code avec des [**fonctions**]{.blue2}
  - [**Mod√©liser**]{.blue2} sa cha√Æne sous forme de [**DAG**]{.blue2}

. . .

![](img/dag.png){height="250" fig-align="center"}

- Outil : [{targets}](https://books.ropensci.org/targets/)

## "Not just once"

- Le [**code**]{.orange} / les [**donn√©es**]{.orange} changent... et [**cassent**]{.orange}

- Sp√©cifier les [**attendus**]{.orange}
  - [**Tests unitaires**]{.orange} : v√©rifie le bon [**comportement**]{.blue2} du code
  - [**Validation de donn√©es**]{.orange} : v√©rifie l'[**int√©grit√©**]{.blue2} et la [**qualit√©**]{.blue2} des donn√©es

- Outils : [testthat](https://testthat.r-lib.org/) et [pointblank](https://rstudio.github.io/pointblank/)

## "Not just once"

- Les [**d√©pendances**]{.orange} changent (fonctionnalit√©s, *bugs*, failles de s√©curit√©...)

- Arbitrage entre [**√©volutivit√©**]{.orange} et [**stabilit√©**]{.orange}
  - L'[**√©volution des d√©pendances**]{.blue2} est inh√©rente √† la [**maintenance**]{.blue2} d'une cha√Æne de production

- On limite les risques en [**sp√©cifiant l'environnement**]{.orange}
  - [**Fixer**]{.blue2} les versions des packages utilis√©s : [renv](https://rstudio.github.io/renv/articles/renv.html)
  - [**Versionner**]{.blue2} sa cha√Æne de production : tags [Git](https://git-scm.com/doc)

## "Not just once"

- L'[**environnement**]{.orange} change (OS, libs syst√®me, `R`...)
  - Difficult√© principale du [**passage en production**]{.blue2}

- La [**conteneurisation**]{.orange} permet de [**fixer l'environnement**]{.orange}
  - Favorise la [**portabilit√©**]{.blue2}

. . .

![](img/containers-portability.png){height="250" fig-align="center"}

## "Not just once"

- Concevoir sa cha√Æne comme un [***pipeline* de donn√©es**]{.orange}
  - [**Reproductibilit√©**]{.orange} : √©tapes [**int√©gr√©es**]{.blue2} "de bout en bout"
  - [**Stabilit√©**]{.orange} : contr√¥le des [**√©volutions**]{.blue2}
  - [**Portabilit√©**]{.orange} : fluidifie le [**changement d'architecture**]{.blue2}

- Avantage suppl√©mentaire : [**automatisation**]{.orange}

- Outil : [**int√©gration continue**]{.orange} via `GitHub` / `GitLab`
  - Accro√Æt encore les b√©n√©fices d'utiliser `Git` ! 

## Les trois commandements d'Hadley

::: {.nonincremental}
- Le [**code de production**]{.orange} a trois caract√©ristiques
  - <span style="color: lightgrey;"><strong>"Not just me"</strong></span>
  - <span style="color: lightgrey;"><strong>"Not just once"</strong></span>
  - [**"Not just my computer"**]{.blue2}

![](img/hadley.jpg){height="250" fig-align="center"}
:::

## "Not just my computer"

- Evolution continue vers des infrastructures de [**self "*production-ready*"**]{.orange}

. . .

![](img/evo-infra.png){height="400" fig-align="center"}

## "Not just my computer"

- OK, mais pourquoi ü§î ?

- Pourquoi migrer vers des [**infrastructures centralis√©es**]{.orange} ?
  - [**Centralisation**]{.orange} : permet le [**passage √† l'√©chelle**]{.blue2}
  - [**S√©curit√©**]{.orange} : √©vite la [**diss√©mination**]{.blue2} de donn√©es

- Pourquoi migrer vers des [**infrastructures Kubernetes**]{.orange} ?
  - Tout ce qu'on pouvait faire avant... [**en mieux**]{.blue2}
  - [**Nouveaux usages**]{.orange} : d√©ploiements (applications, API), calcul distribu√©, traitements ordonnanc√©s...
  - [**Autonomie**]{.orange} (environnement, stockage, etc.)

## "Not just my computer" {auto-animate=true}

Un point de d√©part commun

![](img/environment_messy.png)

## "Not just my computer" {auto-animate=true}

Un point de d√©part commun ![](img/environment_messy.png){width="10%" fig-align="right"}

Une structuration de projet plus viable

![](img/environment_clean.png)

## "Not just my computer" {auto-animate=true}

Un point de d√©part commun ![](img/environment_messy.png){width="10%" fig-align="right"}

Une structuration de projet plus viable ![](img/environment_clean.png){width="10%" fig-align="right"}

Facilit√©e par [**l'√©co-syst√®me *cloud***]{.orange}

![](img/environment_cloud.png)

## "Not just my computer"
  
- Qu'est-ce qui change ü§î ? 

- [**Techniquement**]{.orange}, tout... ou presque !
  - Du monde [***desktop***]{.blue2} au monde [***server***]{.blue2}
  - Du monde [***Windows***]{.blue2} au monde [***Linux***]{.blue2}

- En pratique, [**Onyxia**]{.orange} facilite la [**transition**]{.orange}

. . .

![](img/onyxia-catalog.png){height="250" fig-align="center"}

## "Not just my computer"

- Qu'est-ce qui change ü§î ?

- [**Monde conteneuris√©**]{.orange} : les traitements sont [**√©ph√©m√®res**]{.orange}
  - "Co√ªt" de l'[**autonomie**]{.blue2} et de la [**mutualisation**]{.blue2} 
  - Mais source de [**reproductibilit√©**]{.blue2} !

. . .

![](img/environment_clean.png){height="300" fig-align="center"}

## "Not just my computer"

- Qu'est-ce qui change ü§î ? 
  - Evolution du [**mode de stockage de donn√©es**]{.orange}

- Infrastructures [**"bureau virtuel"**]{.orange} : [**lecteurs partag√©s**]{.blue2}
  - Le "bureau virtuel" simule le [***filesystem* traditionnel**]{.blue2}

- Infrastructures [**cloud**]{.orange} : [**stockage objet**]{.orange} (`S3` / `MinIO`)
  - Stockage [**tr√®s peu co√ªteux**]{.blue2} 
  - [**Autonomie**]{.orange} : [***bucket***]{.blue2} personnel / de projet
  - [**Fonctionnement diff√©rent**]{.blue2} des *filesystems*

## "Not just my computer"

- Qu'est-ce qui change ü§î ? 

- Evolution de la [**nature des traitements**]{.orange}
  - Traitements [**interactifs**]{.blue2} pour le [**d√©veloppement**]{.blue2}
  - Traitements [**batch**]{.blue2} pour le [**d√©ploiement**]{.blue2}

- Le [**d√©bogage**]{.orange} devient moins imm√©diat
  - N√©cessit√© du [***logging***]{.blue2} : [logger](https://cran.r-project.org/web/packages/logger/vignettes/Intro.html)

## D√©passer le "mur de la production"

- Une organisation limit√©e par l'[**h√©t√©rog√©n√©it√© des environnements**]{.orange}

. . .

![](img/mur-prod.png){height="400" fig-align="center"}

## D√©passer le "mur de la production"

- L'opportunit√© d'organisations [**plus continues**]{.orange}

. . .

![](img/ideal.png){height="450" fig-align="center"}





## Application 5: partie 1 {.smaller}

:::: {.callout-tip .nonincremental collapse="true" icon=false}
## Partie 1 : transition vers le stockage `S3`

<!-------
Tout au long de la formation, on se pla√ßait d√©j√† dans le paradigme *cloud* dans la mesure o√π l'on d√©veloppait dans des **conteneurs** h√©berg√©s sur des serveurs distants. N√©anmoins, on a trait√© le stockage de mani√®re "traditionnelle", en important/exportant les fichiers depuis/vers le stockage **local** au conteneur. L'objectif de cet exercice est de transitionner vers un stockage *cloud*, en l'occurence le stockage de type `S3`.
---------->

1. En d√©but de script, cr√©er les chemins o√π les donn√©es pourront √™tre trouv√©es (voir ci-dessous)
2. Cr√©er un connecteur `Arrow` entre votre session `R` et l'espace de stockage `S3`

```{.r}
bucket <- s3_bucket(bucket_formation, endpoint_override = Sys.getenv("AWS_S3_ENDPOINT"))
bucket_path <- bucket$path(paste0(path_within_bucket, "/RPindividus"))
```

3. Dans `main.R`, modifier les codes utilisant `open_dataset` pour remplacer les chemins par la variable `bucket_path`.

```{.r}
df <- open_dataset(
  bucket_path,
  hive_style = TRUE
) %>%
  filter(REGION == 24) %>%
  select(any_of(columns_subset)) %>%
  collect()
```

4. Si n√©cessaire, remplacer l'import du geojson 

```{.r}
departements <- aws.s3::s3read_using(
  FUN = sf::st_read, 
  object = "france.geojson", 
  bucket = "public/ssplab-formation",
  opts = list("region" = "")
  )

```


<br>

<details>

<summary>
Connecteur pour la question 1
</summary>

::: {.panel-tabset}

## {{< fa brands github >}} 


```{.r}
bucket_formation <- "projet-formation"
path_within_bucket <- "/bonnes-pratiques/data"
```

## {{< fa brands gitlab >}} insee


```{.r}
bucket_formation <- "public"
path_within_bucket <- "/ssplab-formation"
```

:::



</details>


::::

## Application 5: partie 2 {.smaller}

:::: {.callout-tip collapse="true" icon=false}
## Partie 2 : orchestrer sa cha√Æne de production

Au fil des chapitres pr√©c√©dents, nous avons appliqu√© un ensemble de bonnes pratiques √† notre cha√Æne de production pour accro√Ætre sa qualit√© et sa maintenabilit√©. N√©anmoins, celle-ci est encore sous la forme d'un unique *script*. 

De mani√®re g√©n√©rale, on a plut√¥t envie de mod√©liser les √©tapes d'une cha√Æne comme une s√©rie de fonctions, avec une fonction "cheffe d'orchestre" qui appelle les autres dans le bon ordre.

::: {.nonincremental}

1. Cr√©er les scripts suivants:
  * `R/functions_import.R` ([contenu](https://raw.githubusercontent.com/InseeFrLab/formation-bonnes-pratiques-git-R/refs/heads/main/R/checkpoints/application5_part2/R/functions_import.R))
  * `R/functions_stats_desc.R` ([contenu](https://raw.githubusercontent.com/InseeFrLab/formation-bonnes-pratiques-git-R/refs/heads/main/R/checkpoints/application5_part2/R/functions_stats_desc.R))
  * `R/functions_models.R` ([contenu](https://raw.githubusercontent.com/InseeFrLab/formation-bonnes-pratiques-git-R/refs/heads/main/R/checkpoints/application5_part2/R/functions_models.R))

2. Modifier `main.R` pour tenir compte de la modularisation ([contenu](https://raw.githubusercontent.com/InseeFrLab/formation-bonnes-pratiques-git-R/refs/heads/main/R/checkpoints/application5_part2/main_sspcloud.R))

3. Passer la souris sur une des nouvelles fonctions et faire <kbd>F1</kbd>

:::

::::


::: {.callout-note}
## `targets`: un orchestrateur formel

On aurait pu √©galement utiliser un **orchestrateur** d√©di√© pour effectuer cette t√¢che, comme le package [targets](https://books.ropensci.org/targets/). Les plus curieux d'entre vous pourront aller voir [le chapitre et les exercices](https://github.com/InseeFrLab/formation-bonnes-pratiques-git-R/blob/main/slides/legacy/data_pipelines.qmd) qui lui √©taient auparavant d√©di√©s dans cette formation.

:::

## Application 5: partie 3 {.smaller}


:::{.callout-tip collapse="true" icon=false .noincremental}
## Partie 3 : ajout de contr√¥les de qualit√© des donn√©es

Un crit√®re de qualit√© majeur d'une cha√Æne de production est sa robustesse. Naturellement, les donn√©es en entr√©e de la cha√Æne peuvent √©voluer dans le temps. Afin de g√©rer au mieux les risques pos√©s par de telles √©volutions, on va ajouter des contr√¥les sur la qualit√© des donn√©es, en entr√©e et en sortie de la cha√Æne.

:::

:::{.callout-tip collapse="true" icon=false .noincremental}
## Partie 4 : tests unitaires et versionnage de la cha√Æne

Notre cha√Æne tourne √† pr√©sent de mani√®re robuste. Pour autant, ce n'est pas un objet fixe : on peut vouloir lui apporter des corrections ou des am√©liorations fonctionnelles. Et ces modifications peuvent, √† leur tour, provoquer des nouvelles erreurs. Pour g√©rer ces risques, on va :
- versionner la cha√Æne, afin de certifier le code qui la fait tourner sans erreur √† un moment T
- impl√©menter des tests unitaires, qui permettent de continuer √† modifier la cha√Æne sans risquer de **r√©gressions**

:::

:::{.callout-tip collapse="true" icon=false .noincremental}
## Partie 5 : un rapport reproductible pour documenter sa cha√Æne de production

Une bonne mani√®re de favoriser √† la fois la maintenabilit√© de sa cha√Æne et la r√©utilisationde ses produits est de documenter son fonctionnement. Le format [quarto](https://quarto.org) ‚Äî successeur de `R Markdown` ‚Äî permet de reproduire facilement des **rapports reproductibles, qui int√®grent code et texte**. En plus, ces rapports peuvent √™tre facilement publi√©s en diff√©rents formats, du plus **interactif** (`html`) aux plus classiques (`pdf`, `odt`, etc.).

:::

:::{.callout-tip collapse="true" icon=false .noincremental}
## Partie 6 : automatiser la mise √† disposition

On dispose finalement d'une cha√Æne **orchestr√©e, robuste et bien document√©e**. Afin d'en faire une cha√Æne vraiment int√©gr√©e de bout en bout, on va **automatiser** les √©tapes, de sorte √† ce que les modifications apport√©es au projet se r√©p√©rcutent sur ses sorties. Pour cela, on va utiliser les outils de l'**int√©gration continue** propos√©s par `GitHub` / `GitLab`.

:::
