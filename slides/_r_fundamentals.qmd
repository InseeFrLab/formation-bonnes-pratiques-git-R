{{< include applications_r/_application0.qmd >}}


# I- QualitÃ© du code

## Enjeux

- D'une vision utilitariste du code Ã  une vision du code comme [**outil de communication**]{.orange}


- Favoriser la [**lisibilitÃ©**]{.orange} et la [**maintenabilitÃ©**]{.orange}


- Faciliter la [**rÃ©utilisation**]{.orange}


- Assurer la [__transparence__]{.orange} mÃ©thodologique


## Principes gÃ©nÃ©raux

:one: Adopter les [**standards communautaires**]{.orange}

:two: Eviter la [**duplication de code**]{.orange}

:three: [**(Auto)-documenter**]{.orange} son code

:four: Isoler la [**configuration**]{.orange} du code

## :one: Adopter les standards communautaires

> *"Good coding style is like correct punctuation: you can manage without it, butitsuremakesthingseasiertoread"*
>
> [Tidyverse Style Guide](https://style.tidyverse.org/)


- Respecter les [conventions]{.orange} du langage dans lequel il est rÃ©digÃ©


- Il existe un **guide de rÃ©fÃ©rence** pour bien coder en `R` : le [Tidyverse style guide](https://style.tidyverse.org/index.html).


## :one: Adopter les standards communautaires {.smaller}

Deux outils pratiques aident Ã  respecter les standards :

1. [**_linter_**]{.orange} : programme qui vÃ©rifie que le code est __formellement__ conforme Ã  un certain _guidestyle_
    + signale problÃ¨mes formels, sans corriger 


2. [**_formatter_**]{.orange} : programme qui reformate un code pour le rendre conforme Ã  un certain _guidestyle_
    + modifie directement le code

. . .

::: {.callout-tip}
::: {.nonincremental}
- [Exemples dâ€™erreurs repÃ©rÃ©es]{.blue2} par un _linter_ : 
    + lignes de code trop longues ou mal indentÃ©es, parenthÃ¨ses non Ã©quilibrÃ©es, noms de fonctions mal construitsâ€¦
- [Exemples dâ€™erreurs __non__ repÃ©rÃ©es]{.blue2} par un _linter_ :
    + fonctions mal utilisÃ©es, arguments mal spÃ©cifiÃ©s, structure du code incohÃ©rente, code insuffisamment documentÃ©â€¦
:::
:::


## :one: Adopter les standards communautaires {.smaller}

<br>

Dans le cas de {{< fa brands r-project >}} : 

- le [_linter_]{.orange} Ã  utiliser est le _package_ [`lintr`](https://github.com/r-lib/lintr)
- le [_formatter_]{.orange} Ã  utiliser est le _package_ [`styler`](https://github.com/r-lib/styler).
    + Existe Ã©galement le _package_ [`formatR`](https://github.com/yihui/formatR).

## :two: Utiliser des fonctions {.smaller}

::: {.callout-important}
## RÃ¨gle d'or

Il faut utiliser une [**fonction**]{.red2} dÃ¨s qu'on utilise une mÃªme
portion de code plus de deux fois ([**_don't repeat yourself_ (DRY)**]{.red2})
:::

- [Limite les risques d'erreurs]{.orange} liÃ©s aux copier/coller
- Rend le code [plus lisible]{.orange} et [plus compact]{.orange}
- [Un seul endroit]{.orange} du code Ã  modifier lorsqu'on souhaite modifier le traitement
- Facilite la [rÃ©utilisation]{.orange} et la [documentation]{.orange} du code !

. . .

::: {.callout-tip}
## RÃ¨gles pour Ã©crire des fonctions **pertinentes**

::: {.nonincremental}
- Une tÃ¢che = une fonction
- Une tÃ¢che complexe = un enchaÃ®nement de fonctions rÃ©alisant chacune une tÃ¢che simple
- Limiter l'utilisation de variables globales.
:::

:::

## :three: Documenter son code

- Grands principes :
  - Documenter le [__pourquoi__]{.orange} plutÃ´t que le [__comment__]{.orange}
  - PrivilÃ©gier l'[**auto-documentation**]{.orange}

. . .

::: {.callout-tip}
## Comment bien documenter un script ?

::: {.nonincremental}
- [**Minimum**]{.orange} ğŸš¦ : commentaire au dÃ©but du script pour dÃ©crire ce qu'il fait
- [**Bien**]{.orange} ğŸ‘ : commenter les parties "dÃ©licates" du code
- [**IdÃ©al**]{.orange} ğŸ’ª : documenter ses fonctions avec la syntaxe `roxygen2`.
:::

:::

## :three: Documenter son code

::: {.callout-tip}
## L'auto-documentation en pratique


ğŸ‘ La documentation pallie des mauvais nommages

```
# Utilise string si x est non manquant et non vide
if (!is.na(x) && nzchar(x)) {
  use_string(x)
}
```

ğŸ‘ Les nommages suffisent Ã  comprendre le code

```
x_is_not_empty_string <- (!is.na(x) && nzchar(x))
if (x_is_not_empty_string) {
  use_string(x)
}
```

:::

## :four: Isoler la configuration du code

- Rappel : on vise une structure [**modulaire**]{.orange}

. . .

![](img/environment.png)

- En pratique : [**isoler**]{.orange} les [**packages**]{.blue2} et les [**secrets**]{.blue2}

## :four: Gestion des packages {.smaller}

- [**Externaliser**]{.orange} l'installation des packages nÃ©cessaires
  - Le code ne doit [**pas modifier l'environnement**]{.blue2}
  - [**OÃ¹ ?**]{.blue2} Dans le `README` ou des fichiers spÃ©cialisÃ©s (`DESCRIPTION` ou `renv.lock`)

- [**Expliciter**]{.orange} l'appel des packages avec la syntaxe `package::fonction()`
  - Favorise la [**lisibilitÃ©**]{.blue2} du code
  - Limite les risques de [**fonctions "masquÃ©es"**]{.blue2}

. . .

:::{.callout-tip}
## Exemple

::: {.nonincremental}
- `package1` et `package2` contiennent chacun une fonction appelÃ©e `super_fonction`.
- Si `package2` est chargÃ© aprÃ¨s `package1`, alors la fonction de `package1` est automatiquement masquÃ©e et `super_fonction` dÃ©signe par dÃ©faut la fonction de `package2`.
- Mieux vaut noter `package1::superFonction` et `package2::superFonction`
:::

:::

## :four: Gestion des secrets

- Les [**secrets**]{.orange} (mots de passe, *tokens*, etc.) sont des [**donnÃ©es sensibles**]{.orange}

- Quelques [**principes de sÃ©curitÃ©**]{.orange} essentiels
  - Utiliser des [***tokens***]{.blue2} plutÃ´t que des mots de passe
  - Utiliser des [**comptes de service**]{.blue2} (quand c'est possible)
  - Jamais de [**secrets en clair**]{.blue2} dans le code

- En pratique, deux [**recommendations selon l'usage**]{.orange} 
  - [**Demander interactivement**]{.blue2} le secret Ã  l'utilisateur
  - SpÃ©cifier des [**variables d'environnement**]{.blue2} via le [fichier .Renviron](https://book.utilitr.org/01_R_Insee/Fiche-personnaliser-R.html#le-fichier-.renviron) (âš ï¸ Ã  ajouter au `.gitignore`)
  



## Ressources supplÃ©mentaires

<br>

- Une [prÃ©sentation](https://jolicode.netlify.app/) de MaÃ«lle Salmon sur le Â« code beau Â».
- Une [prÃ©sentation trÃ¨s complÃ¨te](https://mitmat.github.io/slides/2022-05-26-egu/code-data-open-science.html#1) sur le partage de code et de donnÃ©es avec `R`
- Une [documentation](https://cran.r-project.org/web/packages/httr/vignettes/secrets.html) (en anglais) sur la gestion des secrets (*tokens*, mots de passe, etc.)


{{< include applications_r/_application1.qmd >}}


## Bilan

::::: {.columns}

:::: {.column width="60%"}

- Un code mal structurÃ©
  - Limite la lisibilitÃ© du projet
  - Est trÃ¨s coÃ»teux Ã  maintenir (dette technique)

- Les petits gestes peuvent Ã©conomiser un temps prÃ©cieux

::::

:::: {.column width="40%"}
::: {layout="[[-1], [1], [-1]]"}
![](img/reproducibility-lazy-no-bg.png){fig-align="center"}
:::
::::

:::::









# II- Structure des projets

## Enjeux

1. Favoriser la [**lisibilitÃ©**]{.orange} et la [**maintenabilitÃ©**]{.orange}

2. Construire des projets [**reproductibles**]{.orange}

## :warning: A ne pas reproduire chez vous

<br>

```
â”œâ”€â”€ report.Rmd
â”œâ”€â”€ correlation.png
â”œâ”€â”€ data.csv
â”œâ”€â”€ data2.csv
â”œâ”€â”€ fig1.png
â”œâ”€â”€ figure 2 (copy).png
â”œâ”€â”€ report.pdf
â”œâ”€â”€ partial data.csv
â”œâ”€â”€ script.R
â””â”€â”€ script_final.R
```

Source : [eliocamp.github.io](https://eliocamp.github.io/reproducibility-with-r/materials/day1/02-projects/)

## Principes gÃ©nÃ©raux

1. Utiliser les [**projets RStudio**]{.orange}


2. Organiser son projet en [**sous-dossiers**]{.orange}


3. Donner des [**noms pertinents**]{.orange} aux fichiers


4. [**Documenter**]{.orange} son projet


5. (Faire de son projet un [**package**]{.orange})

## :one: Utiliser les projets RStudio

- [**Objectif**]{.orange} : favoriser la [**reproductibilitÃ©**]{.blue2}
  - Tous les fichiers nÃ©cessaires au projet dans un mÃªme dossier
  - Le dossier contenant le projet RStudio est automatiquement utilisÃ© comme ***working directory***
  - Utilisation de [**chemins relatifs**]{.blue2} plutÃ´t qu'absolus.


- **Bonus** : en utilisant `Git`, on s'assure de toujours travailler dans un projet RStudio !

## :two: Organiser son projet en sous-dossiers

:::{.nonincremental}
- [**Objectif**]{.orange} : adopter une structure arbitraire, mais [**lisible**]{.blue2} et [**cohÃ©rente**]{.blue2}

```
â”œâ”€â”€ data
â”‚   â”œâ”€â”€ raw
â”‚   â”‚   â”œâ”€â”€ data.csv
â”‚   â”‚   â””â”€â”€ data2.csv
â”‚   â””â”€â”€ derived
â”‚       â””â”€â”€ partial data.csv
â”œâ”€â”€ R
|   â”œâ”€â”€ script.R
â”‚   â”œâ”€â”€ script_final.R
â”‚   â””â”€â”€ report.Rmd
â””â”€â”€ output
    â”œâ”€â”€ fig1.png
    â”œâ”€â”€ figure 2 (copy).png
    â”œâ”€â”€ figure10.png
    â”œâ”€â”€ correlation.png
    â””â”€â”€ report.pdf
```
:::

## :three: Donner des noms pertinents aux fichiers

:::{.nonincremental}
- [**Objectif**]{.orange} : [**auto-documenter**]{.blue2} son projet

```
â”œâ”€â”€ data
â”‚   â”œâ”€â”€ raw
â”‚   â”‚   â”œâ”€â”€ dpe_logement_202103.csv
â”‚   â”‚   â””â”€â”€ dpe_logement_202003.csv
â”‚   â””â”€â”€ derived
â”‚       â””â”€â”€ dpe_logement_merged_preprocessed.csv
â”œâ”€â”€ R
|   â”œâ”€â”€ preprocessing.R
â”‚   â”œâ”€â”€ generate_plots.R
â”‚   â””â”€â”€ report.Rmd
â””â”€â”€ output
    â”œâ”€â”€ histogram_energy_diagnostic.png
    â”œâ”€â”€ barplot_consumption_pcs.png
    â”œâ”€â”€ correlation_matrix.png
    â””â”€â”€ report.pdf
```
:::

## :four: Documenter son projet

- Le fichier `README.md`, situÃ© Ã  la racine du projet, est Ã  la fois la **carte d'identitÃ©** et la **vitrine du projet**

- IdÃ©alement, il contient :
  - Une [**prÃ©sentation**]{.orange} du contexte et des objectifs
  - Une description de son [**fonctionnement**]{.orange}
  - Un guide de [**contribution**]{.orange} (*open-source*)


- Quelques modÃ¨les de `README.md` complets :
  - [utilitR](https://github.com/InseeFrLab/utilitR/blob/master/README.md)
  - [DoReMIFaSol](https://github.com/InseeFrLab/DoReMIFaSol)

## :five: Faire de son projet un *package*

- Un *package* est la forme maximale de [**modularitÃ©**]{.orange}
  - Contient des [**fonctions**]{.blue2} rangÃ©es dans des [**modules**]{.blue2}
  - Contient Ã©galement de la [**documentation**]{.blue2}, des [**tests**]{.blue2}, des (mÃ©ta-)donnÃ©es... 

- [**Avantages**]{.orange}
  - IdÃ©al pour favoriser la [**rÃ©utilisation**]{.blue2} du code
  - Des [**outils**]{.blue2} de dÃ©veloppement : `devtools` et `usethis`

- [**InconvÃ©nients**]{.orange}
  - CoÃ»t de [**maintenance**]{.blue2} Ã©levÃ©

## Ressources supplÃ©mentaires

<br>

- La documentation utilitR sur les [projets RStudio](https://book.utilitr.org/03_Fiches_thematiques/Fiche_rprojects) et les [packages R](https://book.utilitr.org/01_R_Insee/Fiche_installer_packages)
- La [bible des packages R](https://r-pkgs.org/whole-game.html)


{{< include applications_r/_application2.qmd >}}




# III- Formats de donnÃ©es

## Enjeux

- Le choix d'un format de donnÃ©es rÃ©pond Ã  un [**arbitrage**]{.orange} entre plusieurs critÃ¨res :
  - [**Public cible**]{.blue2}
  - [**FinalitÃ©**]{.blue2} (traitement, analyse, diffusion)
  - [**VolumÃ©trie**]{.blue2}
  - [**InteropÃ©rabilitÃ©**]{.blue2}

## Formats traditionnels

- Formats de donnÃ©es adhÃ©rents Ã  un langage ([**sas7bdat**]{.orange}, [**RDS**]{.orange}, [**fst**]{.orange}, etc.)
  - [**Non-interopÃ©rables**]{.blue2} -> Ã  Ã©viter !

- Le format [**CSV**]{.orange}
  - [**InteropÃ©rable**]{.blue2} et [**simple**]{.blue2} d'utilisation
  - Pas de gestion des [**mÃ©ta-donnÃ©es**]{.blue2}
  - Peu adaptÃ© aux [**donnÃ©es volumineuses**]{.blue2}

## Limites du `CSV`

- Des [**performances limitÃ©es**]{.orange}
  - [**Stockage**]{.blue2} : non-compressÃ© -> [**espace disque Ã©levÃ©**]{.blue2}
  - [**Lecture**]{.blue2} : "orientÃ©-ligne" -> [**performances faibles**]{.blue2}

. . .

![](img/row-column.png){fig-align="center"}

## Le format `Parquet`

- [**Stockage**]{.orange} :
    - [**Compression**]{.blue2} : entre 5 et 20 fois plus lÃ©ger qu'un CSV

. . .

::: {.nonincremental}
::::: {.callout-note}
## Exemple: Recensement de la Population

- [Ficher dÃ©tail](https://www.insee.fr/fr/statistiques/8268848?sommaire=8205966) : 20 millions de lignes, 92 variables
    - CSV: > 4Go
    - Parquet: < 500Mo
:::::
:::

## Le format `Parquet`

- [**Lecture**]{.orange} :
    - Jusquâ€™Ã  34x plus rapide quâ€™un CSV

- [**"OrientÃ© colonne"**]{.orange}
  - OptimisÃ© pour les [**traitements analytiques**]{.blue2}
  - Limite la quantitÃ© de donnÃ©es Ã  mettre en mÃ©moire

. . .

![](img/parquet-read-columns.png){fig-align="center"}

## Le format `Parquet`

- [**Partitionner**]{.orange} les donnÃ©es pour [**optimiser la lecture**]{.blue2}

. . .

![](img/partitions.png){fig-align="center" height="250"}

::: {.nonincremental}
::::: {.callout-warning}
## L'art de bien partitionner

- Partitionner par une/des [**variable(s) d'intÃ©rÃªt**]{.blue2} (ex : millÃ©sime x dÃ©partement)

- [**Eviter**]{.blue2} de crÃ©er de [**nombreux petits (< 128Mo) fichiers**]{.blue2}

:::::
:::

## Le format `Parquet`

- Gestion native des [**mÃ©ta-donnÃ©es**]{.orange}
  - DÃ©finition automatique d'un [**schÃ©ma**]{.blue2} (noms, types)
  - Mise Ã  disposition plus [**robuste**]{.blue2}

- [**InteropÃ©rable**]{.orange}

- [**Open-source**]{.orange}

## Utiliser des fichiers `Parquet`

- Deux *frameworks* de rÃ©fÃ©rence : [Arrow](https://book.utilitr.org/03_Fiches_thematiques/Fiche_arrow.html) et [DuckDB](https://book.utilitr.org/03_Fiches_thematiques/Fiche_duckdb.html)
  - Orientation [**fichier**]{.blue2} (`Arrow`) VS orientation [**BDD**]{.blue2} (`DuckDB`)
  - TrÃ¨s bonne [**intÃ©gration**]{.blue2} avec le `tidyverse`
 
- [**Traitement en-mÃ©moire optimisÃ©**]{.orange}
  - [**OrientÃ©s-colonne**]{.blue2}
  - [***Lazy evaluation***]{.blue2}

. . .

::: {.nonincremental}
::::: {.callout-note}
## Exemple d'une requÃªte *lazy*

```R
n_logements_depcom <- achille |> 
  filter(dep %in% c("01", "02", "03")) |>  # RÃ©cupÃ¨re seulement les partitions nÃ©cessaires
  select(idlogement, depcom) |>  # RÃ©cupÃ¨re seulement les colonnes nÃ©cessaires
  group_by(depcom) |>
  summarise(n_logements = n()) |>  
  collect()  # Les calculs ne sont effectuÃ©s qu'Ã  cette Ã©tape !
```

:::::
:::

{{< include applications_r/_application3.qmd >}}
