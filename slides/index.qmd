---
title: Bonnes pratiques pour les projets statistiques
subtitle: |
  **[Une formation aux bonnes pratiques avec Git et R]{.orange}**
author: |
  [Romain Avouac](https://github.com/avouacr),
  [Thomas Faria](https://github.com/ThomasFaria),
  [Lino Galiana](https://www.linogaliana.fr/),
  [Olivier Meslin](https://github.com/oliviermeslin),
  [Tom Seimandi](https://github.com/tomseimandi/)
# date: 
slide-number: true
footer: |
  Bonnes pratiques pour les projets statistiques
# uncomment for French presentations:
#lang: fr-FR
# for blind readers:
slide-tone: false
# for @olevitt:
chalkboard: # press the B key to toggle chalkboard
  theme: whiteboard
# uncomment to use the multiplex mode:
#multiplex: true
format:
  # pick the light mode (onyxia-revealjs) or the dark mode (onyxia-dark-revealjs)
  onyxia-revealjs:
  #onyxia-dark-revealjs:
    output-file: index.html
controls: true
css: custom.css
from: markdown+emoji
bibliography: references.bib
---




# Introduction

## La notion de bonnes pratiques

- [**Origine**]{.blue2} : communaut√© des d√©veloppeurs logiciels

::: {.incremental}
- [**Constats**]{.blue2} :
    - le [_"code est plus souvent lu qu'√©crit"_]{.green2} ([Guido Van Rossum](https://fr.wikipedia.org/wiki/Guido_van_Rossum))
    - la maintenance d'un code est tr√®s co√ªteuse
:::

. . .

- [**Cons√©quence**]{.blue2} : un ensemble de [**r√®gles informelles**]{.orange},
conventionnellement accept√©es comme produisant des logiciels [**fiables**]{.orange}, [**√©volutifs**]{.orange} et [**maintenables**]{.orange}


## Pourquoi s'int√©resser aux bonnes pratiques ? {.smaller}

<br>

L'activit√© du statisticien / *datascientist* tend √† se rapprocher de celle du d√©veloppeur :

. . .

- projets [**intenses en code**]{.orange}

. . .

- [**projets collaboratifs**]{.orange} et de grande envergure

. . .


- [**complexification**]{.orange} des donn√©es et donc des [**infrastructures**]{.orange}

. . .

- [**d√©ploiement**]{.orange} d'applications pour valoriser les analyses

## Bonnes pratiques et reproductibilit√© {.smaller}

![](img/reprospectrum.png){height="200" fig-align="center"}

**Source** : Peng R., Reproducible Research in Computational Science, Science (2011)

. . .

- Une reproductibilit√© parfaite est [**co√ªteuse**]{.orange}

. . .

- `Git` est un [**standard atteignable**]{.orange} et [**efficient**]{.orange}

. . .

::: {.callout-note}
**Quel socle de bonnes pratiques pour les projets statistiques en `R` ?**
:::




# Partie 1 : contr√¥le de version avec `Git`

## Plan de la formation

:one: Le [**contr√¥le de version**]{.orange} : pourquoi faire ?

. . .

:two: Le [**contr√¥le de version**]{.orange} avec `Git`

. . .

:three: Le [**travail collaboratif**]{.orange} avec `Git`


# I- Le contr√¥le de version : pourquoi faire ?

## :one: Archiver son code proprement {auto-animate=true}

pour en finir avec √ßa :

![](img/fichiers_multiples.png)


## :one: Archiver son code proprement {auto-animate=true}

ou √ßa :

![](img/finalfinal.png){fig-align="center"}


## :one: Archiver son code proprement {auto-animate=true}

ou encore √ßa :

```{.python code-line-numbers="12-18"}
prior <- read_csv(prior_path)
prior <- prior %>%
    select(id, proba_inter, proba_build, proba_rfl) %>%
    separate(id, into = c('nidt', 'grid_id'), sep = ":") %>%
    group_by(nidt) %>%
    mutate(
        proba_build = proba_build/sum(proba_build),
        proba_rfl = proba_rfl/sum(proba_rfl),
        ) %>%
    unite(col = "id", nidt, grid_id, sep = ":")

# Test
# prior_test <- prior %>%
#    mutate(
#        proba_inter = round(proba_inter, 4)
#        proba_build = round(proba_build, 4)
#        proba_rfl = round(proba_rfl, 4)
#    )

write_csv(prior_round, "~/prior.csv")
```

## :one: Archiver son code proprement {auto-animate=true}

Pour arriver √† √ßa :

![](img/timeline.png){fig-align="center" height=475}

Source : [ThinkR](https://thinkr.fr/travailler-avec-git-via-rstudio-et-versionner-son-code/)

## :two: Voyager dans le temps (de votre projet)

![](img/historique_utilitr.png){fig-align="center"}

## :three: Une collaboration simplifi√©e et efficace {auto-animate=true}

Un mod√®le distribu√©

![](img/git_distributed.png){fig-align="center" height=475}

Source : [specbee.com](https://www.specbee.com)

## :three: Une collaboration simplifi√©e et efficace {auto-animate=true}

Qui permet l'exp√©rimentation en toute s√©curit√©

![](img/branches.png){fig-align="center"}

Source : [lutece.paris.fr](https://lutece.paris.fr/support/jsp/site/Portal.jsp?page=wiki&view=page&page_name=git&language=fr)

## :three: Une collaboration simplifi√©e et efficace {auto-animate=true}

Quel que soit l'environnement de travail

![](img/envtravail.png){fig-align="center" height=475}

## :three: Une collaboration simplifi√©e et efficace {auto-animate=true}

Avec des outils pour faciliter la collaboration

![](img/issue.png){fig-align="center" height=500}

## :four: Partager son code √† un public large {auto-animate=true}

Une vitrine pour les projets et l'organisation

![](img/ghinseefr.png){fig-align="center" height=475}


## En r√©sum√©

- [__Construire__]{.blue2} et [__naviguer__]{.blue2} √† travers l'[**historique**]{.orange} de son projet

. . .

- La [**collaboration**]{.orange} rendue [__simple__]{.blue2} et [__efficace__]{.blue2}

. . .

- Am√©liorer la [**reproductibilit√©**]{.orange} de ses projets

. . .

- Am√©liorer la [**visibilit√©**]{.orange} de ses projets

# II- Le contr√¥le de version avec `Git`

## :warning: Git est complexe {auto-animate=true}

L'utilisation de `Git` n√©cessite [__certaines notions pr√©alables__]{.orange}:

::: {.incremental}
- Fonctionnement d'un `filesystem`
- Connaissance basique du terminal `Linux`
- Potentiellement, un grand nombre de commandes
:::

![Source : [Ici](https://iulianacosmina.com/?p=19452)](img/gitfire.png){height="400"}

## :warning: Git est complexe {auto-animate=true}

[__Mais__]{.blue2}

::: {.incremental}
- L'**usage quotidien** n'implique que [**quelques commandes**]{.orange}
- [**Enorm√©ment de ressources**]{.orange} disponibles sur internet
- Des [**interfaces visuelles**]{.orange} (ex: `RStudio`, `Sublime Merge`, `VS Code`) qui facilitent l'apprentissage
- Un petit investissement individuel pour de [**gros gains collectifs**]{.orange}
:::


## Concepts {auto-animate=true}

#### `Git`, `GitHub`, `GitLab`... quelles diff√©rences ?

:::{.incremental}
- `Git` est un **logiciel** ;
- Utilisation en ligne de commandes
- Diff√©rentes [__interfaces graphiques__]{.blue2} (`RStudio`, `VS Code`...)
:::

## Concepts {auto-animate=true}

#### `Git`, `GitHub`, `GitLab`... quelles diff√©rences ?


:::{.incremental}
- `GitHub` et `GitLab` sont des **forges logicielles**
- _Forge_: espace d'archivage de code
- Des fonctionalit√©s suppl√©mentaires : __r√©seau social du code__
:::

:::{.callout-tip}

- `GitHub` : utilisation pour les projets **open-source**
- `GitLab` : utilisation pour les projets **internes**

:::


## Concepts {auto-animate=true}

#### D√©p√¥t local / d√©p√¥t distant (`remote`)

![](img/localremote.png){fig-align="center" height=400}

- Par d√©faut, le d√©p√¥t distant porte l'alias `origin`

<!-- ## Concepts {auto-animate=true}

_Workflow_ (version litt√©raire) :

- On travaille sur un d√©p√¥t local en √©ditant des fichiers
- On dit √† `Git` que ces fichiers doivent √™tre suivis (`staging area`)
- On valide les modifications faites en local (`commit`)
- On soumet les modifications (`push`) apr√®s avoir r√©cup√©r√© la version collective (`pull`) -->

## Concepts {auto-animate=true}

#### _Workflow_ local

![](img/areas.png){fig-align="center" height=400}

Source : [Git Documentation](https://git-scm.com/book/en/v2/Getting-Started-What-is-Git%3F)

## Concepts {auto-animate=true}

#### _Workflow_ complet

![Source : [itnext.io](https://itnext.io/git-concepts-for-newcomers-part-2-git-repository-working-tree-and-staging-area-a2e720bf3528)](img/completeworkflow.png){height="400" width="500"}

## Commandes essentielles {auto-animate=true}

<br> 

| Action     | Commande      |
|------------|---------------|
| Cloner un projet | `git clone [url-to-git-repo]` |
| Afficher les changements | `git status` |
| Retrouver l'URL du d√©p√¥t distant | `git remote -v` |

## Commandes essentielles {auto-animate=true .smaller}

<br>

| Action     | Commande      |
|------------|---------------|
| Ajouter des changements √† l'index de `Git` | Un seul fichier : `git add <file-name>` <br> Tous les fichiers d√©j√† index√©s : `git add -u` <br> Tous les fichiers :warning: : `git add -A` |

<br>

:::{.callout-important}
## Warning

La m√©thode `git add -A` peut amener √† suivre les modifications
de fichiers qui ne devraient pas l'√™tre (par exemple, des donn√©es).

Il est recommand√© de bien r√©fl√©chir avant de l'utiliser (ou d'avoir
un bon `.gitignore`)

:::

## Commandes essentielles {auto-animate=true}

<br>

| Action     | Commande      |
|------------|---------------|
| Faire un `commit` | `git commit -m "message"`|
| Pousser les changements locaux (branche `master`) | `git push origin master` |
| R√©cup√©rer les changements distants (branche `master`) | `git pull origin master` |

## Modes d'authentification

:::{.incremental}
- [**https**]{.orange}
  - `git clone https://github.com/username/projet.git`
  - simple √† utiliser
  - authentification username/token √† chaque *push*

- [**ssh**]{.orange}
  - `git clone git@github.com:username/projet.git`
  - (plus) complexe √† initialiser
  - authentification automatique 
:::

## Application 0 {.smaller}

{{< include applications_git/_application0.qmd >}}

## Application 1

{{< include applications_git/_application1.qmd >}}

## Application 2

{{< include applications_git/_application2.qmd >}}

## Bonnes pratiques {auto-animate=true .smaller}

__Que versionne-t-on ?__

:::{.incremental}
- Essentiellement du [**code source**]{.orange}
- [__Pas d'outputs__]{.orange} (fichiers `.html`, `.pdf`, mod√®les...)
- [__Pas de donn√©es__]{.orange}, d'informations locales ou sensibles
:::

:::{.callout-note}

Pour d√©finir des r√®gles qui √©vitent de committer tel ou tel fichier, on utilise
un fichier nomm√© __`.gitignore`__.

Si on m√©lange du code et des √©l√©ments
annexes (_output_, donn√©es...) dans un m√™me dossier, il [__faut consacrer du temps √† ce fichier__]{.orange}.

Le site [`gitignore.io`](https://www.toptal.com/developers/gitignore) peut vous fournir
des mod√®les.

N'h√©sitez pas √† y ajouter des r√®gles conservatrices (par exemple `*.csv`), 
comme cela est expliqu√© dans [la documentation `utilitR`](https://www.book.utilitr.org/git.html?q=gitignore#gitignore).

:::

## Bonnes pratiques {auto-animate=true .smaller}

__Format des commits__

::: {layout="[40,60]"}

::: {.incremental}
- [**Fr√©quence**]{.orange}
    - Aussi souvent que possible
    - Le lot de modifications doit "faire sens"
- [**Messages**]{.orange}
    - Courts et informatifs (comme un titre de mail)
    - D√©crire **le pourquoi plut√¥t que le comment** dans le texte
:::

![](img/titre-commit.png)

:::

## Application 3

{{< include applications_git/_application3.qmd >}}


# III- Le travail collaboratif avec Git

## Outils pour le travail collaboratif

- L'√©co-syst√®me `Git` [**facilite** le travail collaboratif]{.blue2}
    - `Git` {{< fa brands git-alt >}} : mod√®le des [__branches__]{.orange}
    - `GitHub` {{< fa brands github >}} / `GitLab` {{< fa brands gitlab >}} : [**Issues**, **Pull Requests**, **Forks**]{.orange}

. . .

- Ces outils ne remplacent pas une [**bonne d√©finition de l'organisation du travail**]{.orange} en √©quipe
    - Choix d'un *workflow*
    - Droits d'acc√®s
    - R√®gles de contribution

## Application 4 {.smaller}

{{< include applications_git/_application4.qmd >}}

## Application 5 {.smaller}

{{< include applications_git/_application5.qmd >}}

## Le mod√®le des branches {auto-animate=true}

![](https://i.imgflip.com/4ooord.jpg){fig-align="center"}

## Le mod√®le des branches {auto-animate=true}

![](img/branches.png)

## Exemple d'organisation : le *GitHub flow*

![](img/ghflow.png)

Description plus d√©taill√©e : [ici](https://docs.github.com/en/get-started/quickstart/github-flow)

<!--
## Adopter de bonnes pratiques collaboratives {.smaller}

:warning: __Ne jamais `git push --force`__

![](https://miro.medium.com/max/400/0*XaLzNzYkA6PZjbl9.jpg){height="350" fig-align="center"}
-->

## Application 6

{{< include applications_git/_application6.qmd >}}

## Application 7

{{< include applications_git/_application7.qmd >}}

## Application 8 (bonus)

{{< include applications_git/_application8.qmd >}}

## Ressources suppl√©mentaires {.smaller}

<br>

- Pour **aller plus loin**:
    - Formation [Travail collaboratif avec `R`](https://collaboratif-git-formation-insee.netlify.app/index.html)
    - Cours [Reproductibilit√© et bonnes pratiques pour les projets de data science](https://ensae-reproductibilite.netlify.app/) de l'`ENSAE`
    - La [documentation `utilitR`](https://www.book.utilitr.org/) propose plusieurs chapitres sur `Git`
    - La [Bible](https://git-scm.com/book/en/v2)
<br>

. . .

- **Trouver de l'aide**:
    - Pour toute question : le salon Tchap [Insee-Git-Gitlab](https://tchap.gouv.fr/#/room/#InseeGitGitlablPtu8f1Frns:agent.finances.tchap.gouv.fr)
    - A l'Insee : la [documentation utilisateurs] pour l'utilisation de `Git` sur `AUS`
    - Sollicitez vos coll√®gues utilisateurs de `Git` !







# Partie 2 : bonnes pratiques en `R`

## Plan de la partie

Am√©liorations graduelles dans l'√©chelle de la reproductibilit√© :

:one: Qualit√© du code

. . .

:two: Structure des projets

. . .

:three: Formats de donn√©es

. . .

:four: Environnements reproductibles

. . .

:five: *Pipelines* de donn√©es

. . .

:six: Publication reproductible

. . .

{{< include applications_r/_application0.qmd >}}


# I- Qualit√© du code

## Enjeux

- D'une vision utilitariste du code √† une vision du code comme [**outil de communication**]{.orange}

. . .

- Favoriser la [**lisibilit√©**]{.orange} et la [**maintenabilit√©**]{.orange}

. . .

- Faciliter la [**r√©utilisation**]{.orange}

. . .

- Assurer la [__transparence__]{.orange} m√©thodologique

## Principes g√©n√©raux

1. Adopter les [**standards communautaires**]{.orange}

. . .

2. Utiliser des [**fonctions**]{.orange}

. . .

3. [**Documenter**]{.orange} son code

. . .

4. Indiquer les _packages_ utilis√©s afin d'√©viter les [**conflits**]{.orange}


## :one: Adopter les standards communautaires

> *"Good coding style is like correct punctuation: you can manage without it, butitsuremakesthingseasiertoread"*
>
> [Tidyverse Style Guide](https://style.tidyverse.org/)

. . .

- Respecter les [conventions]{.orange} du langage dans lequel il est r√©dig√©

. . .

- Il existe un **guide de r√©f√©rence** pour bien coder en `R` : le [Tidyverse style guide](https://style.tidyverse.org/index.html).


## :one: Adopter les standards communautaires {.smaller}

Deux outils pratiques aident √† respecter les standards :

1. [**_linter_**]{.orange} : programme qui v√©rifie que le code est __formellement__ conforme √† un certain _guidestyle_
    + signale probl√®mes formels, sans corriger 

. . .

2. [**_formatter_**]{.orange} : programme qui reformate un code pour le rendre conforme √† un certain _guidestyle_
    + modifie directement le code

. . .

::: {.callout-tip}

- [Exemples d‚Äôerreurs rep√©r√©es]{.blue2} par un _linter_ : 
    + lignes de code trop longues ou mal indent√©es, parenth√®ses non √©quilibr√©es, noms de fonctions mal construits‚Ä¶
- [Exemples d‚Äôerreurs __non__ rep√©r√©es]{.blue2} par un _linter_ :
    + fonctions mal utilis√©es, arguments mal sp√©cifi√©s, structure du code incoh√©rente, code insuffisamment document√©‚Ä¶
:::


## :one: Adopter les standards communautaires {.smaller}

<br>

Dans le cas de {{< fa brands r-project >}} : 

- le [_linter_]{.orange} √† utiliser est le _package_ [`lintr`](https://github.com/r-lib/lintr)
- le [_formatter_]{.orange} √† utiliser est le _package_ [`styler`](https://github.com/r-lib/styler).
    + Existe √©galement le _package_ [`formatR`](https://github.com/yihui/formatR).

## :two: Utiliser des fonctions {.smaller}

::: {.callout-important}
## R√®gle d'or

Il faut utiliser une [**fonction**]{.red2} d√®s qu'on utilise une m√™me
portion de code plus de deux fois ([**_don't repeat yourself_ (DRY)**]{.red2})
:::

- [Limite les risques d'erreurs]{.orange} li√©s aux copier/coller
- Rend le code [plus lisible]{.orange} et [plus compact]{.orange}
- [Un seul endroit]{.orange} du code √† modifier lorsqu'on souhaite modifier le traitement
- Facilite la [r√©utilisation]{.orange} et la [documentation]{.orange} du code !

. . .

::: {.callout-tip}
## R√®gles pour √©crire des fonctions **pertinentes**

- Une t√¢che = une fonction
- Une t√¢che complexe = un encha√Ænement de fonctions r√©alisant chacune une t√¢che simple
- Limiter l'utilisation de variables globales.

:::

## :three: Documenter son code

- Grands principes :
  - Documenter le [__pourquoi__]{.orange} plut√¥t que le [__comment__]{.orange}
  - Privil√©gier l'auto-documentation via des [**nommages pertinents**]{.orange}.

. . .

::: {.callout-tip}
## Comment bien documenter un script ?

- [**Minimum**]{.orange} üö¶ : commentaire au d√©but du script pour d√©crire ce qu'il fait
- [**Bien**]{.orange} üëç : commenter les parties "d√©licates" du code
- [**Id√©al**]{.orange} üí™ : documenter ses fonctions avec la syntaxe `roxygen2`.

:::


## :four: Pas d'ambigu√Øt√© sur les _packages_ utilis√©s {.smaller}

- Deux fonctions peuvent avoir le [__m√™me nom__]{.orange} dans des [__packages diff√©rents__]{.orange}

. . .

- `R` utilise par d√©faut la librairie charg√©e le plus r√©cemment

. . .

- Erreurs difficiles √† rep√©rer car il est n√©cessaire d'ex√©cuter le code

. . .

- Recommandation : indiquer explicitement le _package_ : notation `package::fonction()`
    + Exemple : `dplyr::filter()`

:::{.callout-tip}
## Exemple
- `package1` et `package2` contiennent chacun une fonction appel√©e `superFonction`.
- Si `package2` est charg√© apr√®s `package1`, alors `superFonction` d√©signe par d√©faut la fonction de `package2`.
- Mieux vaut noter `package1::superFonction` et `package2::superFonction`
:::


## Ressources suppl√©mentaires

<br>

- [Un cours complet](https://eliocamp.github.io/reproducibility-with-r/) sur la reproductibilit√© avec `R`
- Une [pr√©sentation tr√®s compl√®te](https://mitmat.github.io/slides/2022-05-26-egu/code-data-open-science.html#1) sur le partage de code et de donn√©es avec `R`
- L'√©quivalent `Python` en [3A d'ENSAE](https://ensae-reproductibilite.netlify.app/about/)


{{< include applications_r/_application1.qmd >}}


## Bilan

::: {.incremental}
- Un code mal structur√©
  - Limite la lisibilit√© du projet
  - Est tr√®s co√ªteux √† maintenir (dette technique)
:::

. . .

::: {layout="[80,30]"}

![](https://www.earthdatascience.org/images/earth-analytics/clean-code/reproducible-science-is-about-being-lazy-hadley-wickham.png)

:::

# II- Structure des projets

## Enjeux

1. Favoriser la [**lisibilit√©**]{.orange} et la [**maintenabilit√©**]{.orange}

. . .

2 Construire des projets [**reproductibles**]{.orange}

## :warning: A ne pas reproduire chez vous

<br>

```
‚îú‚îÄ‚îÄ report.Rmd
‚îú‚îÄ‚îÄ correlation.png
‚îú‚îÄ‚îÄ data.csv
‚îú‚îÄ‚îÄ data2.csv
‚îú‚îÄ‚îÄ fig1.png
‚îú‚îÄ‚îÄ figure 2 (copy).png
‚îú‚îÄ‚îÄ report.pdf
‚îú‚îÄ‚îÄ partial data.csv
‚îú‚îÄ‚îÄ script.R
‚îî‚îÄ‚îÄ script_final.R
```

Source : [eliocamp.github.io](https://eliocamp.github.io/reproducibility-with-r/materials/day1/02-projects/)

## Principes g√©n√©raux

1. Utiliser les [**projets RStudio**]{.orange}

. . .

2. Organiser son projet en [**sous-dossiers**]{.orange}

. . .

3. Donner des [**noms pertinents**]{.orange} aux fichiers

. . .

4. [**Documenter**]{.orange} son projet

. . .

5. (Faire de son projet un [**package**]{.orange})

## :one: Utiliser les projets RStudio

::: {.incremental}
- [**Objectif**]{.orange} : favoriser la [**reproductibilit√©**]{.blue2}
  - Tous les fichiers n√©cessaires au projet dans un m√™me dossier
  - Le dossier contenant le projet RStudio est automatiquement utilis√© comme ***working directory***
  - Utilisation de [**chemins relatifs**]{.blue2} plut√¥t qu'absolus.
:::

. . .

- **Bonus** : en utilisant `Git`, on s'assure de toujours travailler dans un projet RStudio !

## :two: Organiser son projet en sous-dossiers

- [**Objectif**]{.orange} : adopter une structure arbitraire, mais [**lisible**]{.blue2} et [**coh√©rente**]{.blue2}

```
‚îú‚îÄ‚îÄ data
‚îÇ   ‚îú‚îÄ‚îÄ raw
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ data.csv
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ data2.csv
‚îÇ   ‚îî‚îÄ‚îÄ derived
‚îÇ       ‚îî‚îÄ‚îÄ partial data.csv
‚îú‚îÄ‚îÄ R
|   ‚îú‚îÄ‚îÄ script.R
‚îÇ   ‚îú‚îÄ‚îÄ script_final.R
‚îÇ   ‚îî‚îÄ‚îÄ report.Rmd
‚îî‚îÄ‚îÄ output
    ‚îú‚îÄ‚îÄ fig1.png
    ‚îú‚îÄ‚îÄ figure 2 (copy).png
    ‚îú‚îÄ‚îÄ figure10.png
    ‚îú‚îÄ‚îÄ correlation.png
    ‚îî‚îÄ‚îÄ report.pdf
```

## :three: Donner des noms pertinents aux fichiers

- [**Objectif**]{.orange} : [**auto-documenter**]{.blue2} son projet

```
‚îú‚îÄ‚îÄ data
‚îÇ   ‚îú‚îÄ‚îÄ raw
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dpe_logement_202103.csv
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dpe_logement_202003.csv
‚îÇ   ‚îî‚îÄ‚îÄ derived
‚îÇ       ‚îî‚îÄ‚îÄ dpe_logement_merged_preprocessed.csv
‚îú‚îÄ‚îÄ R
|   ‚îú‚îÄ‚îÄ preprocessing.R
‚îÇ   ‚îú‚îÄ‚îÄ generate_plots.R
‚îÇ   ‚îî‚îÄ‚îÄ report.Rmd
‚îî‚îÄ‚îÄ output
    ‚îú‚îÄ‚îÄ histogram_energy_diagnostic.png
    ‚îú‚îÄ‚îÄ barplot_consumption_pcs.png
    ‚îú‚îÄ‚îÄ correlation_matrix.png
    ‚îî‚îÄ‚îÄ report.pdf
```

## :four: Documenter son projet

- Le fichier `README.md`, situ√© √† la racine du projet, est √† la fois la **carte d'identit√©** et la **vitrine du projet**

::: {.incremental}
- Id√©alement, il contient :
  - Une [**pr√©sentation**]{.orange} du contexte et des objectifs
  - Une description de son [**fonctionnement**]{.orange}
  - Un guide de [**contribution**]{.orange} (*open-source*)
:::

. . .

- Quelques mod√®les de `README.md` complets :
  - [utilitR](https://github.com/InseeFrLab/utilitR/blob/master/README.md)
  - [DoReMIFaSol](https://github.com/InseeFrLab/DoReMIFaSol)

## :five: Faire de son projet un *package*

::: {.incremental}
- Un *package* est la forme maximale de [**modularit√©**]{.orange}
  - Contient des [**fonctions**]{.blue2} rang√©es dans des [**modules**]{.blue2}
  - Contient √©galement de la [**documentation**]{.blue2}, des [**tests**]{.blue2}, des (m√©ta-)donn√©es... 

- [**Avantages**]{.orange}
  - Id√©al pour favoriser la [**r√©utilisation**]{.blue2} du code
  - Des [**outils**]{.blue2} de d√©veloppement : `devtools` et `usethis`

- [**Inconv√©nients**]{.orange}
  - Co√ªt de [**maintenance**]{.blue2} √©lev√©
:::

## Ressources suppl√©mentaires

<br>

- La documentation utilitR sur les [projets RStudio](https://www.book.utilitr.org/03_fiches_thematiques/fiche_rprojects) et les [packages R](https://www.book.utilitr.org/01_r_insee/fiche_installer_packages)
- La [bible des packages R](https://r-pkgs.org/whole-game.html)
- Un excellent [workshop sur la reproductibilit√© avec R](https://eliocamp.github.io/reproducibility-with-r/materials/day1/02-projects/)


{{< include applications_r/_application2.qmd >}}


# III- Formats de donn√©es

## Enjeux

::: {.incremental}
- Le choix d'un format de donn√©es r√©pond √† un [**arbitrage**]{.orange} entre plusieurs crit√®res :
  - [**Finalit√©**]{.blue2} (traitement, analyse, diffusion)
  - [**Public cible**]{.blue2}
  - [**Volum√©trie**]{.blue2}
:::

## Recommandations {.smaller}

- Eviter imp√©rativement les formats de donn√©es adh√©rents √† un langage (`RDS`, `RData`, `fst`, `sas7bdat`, etc.).

::: {.incremental}
- Deux formats √† privil√©gier :
  - [**CSV**]{.orange} : pour la [**plupart des usages courants**]{.blue2}
    - _Avantage_ : [**non-compress√©**]{.blue2} donc facilement [**lisible**]{.blue2}
    - _Inconv√©nients_ : pas de gestion des m√©ta-donn√©es, peu adapt√© aux donn√©es volumineuses
  - [**Parquet**]{.orange} : pour le traitement de [**donn√©es volumineuses**]{.blue2}
    - [**Compress√©**]{.blue2} et tr√®s [**performant**]{.blue2} en lecture/√©criture
    - Gestion native des m√©ta-donn√©es
:::


{{< include applications_r/_application3.qmd >}}


# IV- Environnements reproductibles

## Exp√©rience de pens√©e

::: {.incremental}
- Imaginons la situation suivante :
  - J'installe une version de `R` sur mon poste
  - Je d√©veloppe un projet en installant les _packages_ n√©cessaires
  - Une fois termin√©, je passe au projet suivant, et ainsi de suite.


- Quels [**probl√®mes**]{.orange} puis-je rencontrer au fil des projets ?

- Est-il facile de [**partager**]{.orange} un de mes projets ?
:::

## Enjeux

- [**Version de**]{.orange} [**R**]{.blue2} [**fixe**]{.orange}, celle de l'installation syst√®me

. . .

- [**Conflits de version**]{.orange} : diff√©rents projets peuvent requ√©rir diff√©rentes versions d'un m√™me _package_.

. . .

- [**Reproductibilit√© limit√©e**]{.orange} : difficile de dire quel projet n√©cessite quel _package_.

. . .

- [**Portabilit√© limit√©e**]{.orange} : difficile de pr√©ciser dans un fichier les d√©pendances sp√©cifiques √† un projet.


## Des environnements reproductibles avec `renv`

- `renv` permet de cr√©er des **env**ironnements **r**eproductibles

. . .

- [**Isolation**]{.orange} : chaque projet dispose de sa propre librairie de packages

. . .

- [**Reproductibilit√©**]{.orange} : `renv` enregistre les versions exactes des *packages* n√©cessaires au projet

. . .

- [**Portabilit√©**]{.orange}: un tiers peut ex√©cuter le projet avec les m√™mes sp√©cifications

## Utilisation de `renv`

1. [**Initialisation**]{.orange} (`init`) de l'environnement local du projet

. . .

2. [**D√©veloppement**]{.orange} du projet

. . .

3. [**Enregistrement**]{.orange} (`snapshot`) des versions des *packages* install√©s

. . .

4. [**Restauration**]{.orange} (`restore`) d'un environnement

## :one: Initialisation de l'environnement

::: {.incremental}
- `renv::init()` dans un projet RStudio cr√©e :
  - Un dossier `renv` et le fichier `.Rprofile` : activation automatique de l'environnement
  - Le fichier `renv.lock` : versions des *packages* install√©s
:::

. . .

![](img/renv_init.png){height="400" fig-align="center"}

## :two: D√©veloppement du projet

::: {.incremental}
- Une fois l'environnement initialis√©, on d√©veloppe le projet de mani√®re habituelle :
  - Installations/suppressions/mises √† jour de packages
  - Ecriture de scripts
:::

. . .

- `renv::status()` : indique les _packages_ install√©s/supprim√©s par rapport au fichier `renv.lock`

## :three: Enregistrement de l'environnement {.smaller}

- `renv::snapshot()` : enregistre les versions des _packages_ install√©s dans le fichier `renv.lock`

. . .

![](img/renv_snapshot.png){height="400" fig-align="center"}

## :four: Restauration de l'environnement

- `renv::restore()` : installe/d√©sinstalle les _packages_ n√©cessaires pour arriver √† l'√©tat sp√©cifi√© dans le fichier `renv.lock`

. . .

- [**Portabilit√©**]{.orange} : un tiers peut recr√©er un environnement avec les m√™mes sp√©cifications


{{< include applications_r/_application4.qmd >}}


## Vers une reproductibilit√© optimale

::: {.incremental}
- [**Limites**]{.orange} des environnements virtuels : 
  - Les [**librairies syst√®me**]{.blue2} ne sont pas g√©r√©es
  - Lourdeur de la phase d'installation √† chaque changement d'environnement
  - Peu adapt√©s √† un environnement de production
:::

. . .

- La [**conteneurisation**]{.orange} (ex : `Docker`) apporte la solution

. . .

- [**Intuition**]{.orange} : au lieu de distribuer la recette pour recr√©er l'environnement, [**distribuer directement une "machine" qui contient *tout* l'environnement n√©cessaire au projet**]{.blue2}

## Ressources suppl√©mentaires

- La [documentation officielle de `renv`](https://rstudio.github.io/renv/articles/renv.html)

- La [fiche utilitR sur la gestion des d√©pendances](https://www.book.utilitr.org/03_fiches_thematiques/fiche_gerer_dependances)

# V- *Pipelines* de donn√©es

## Motivations

- Une analyse de donn√©es ou une cha√Æne de production font intervenir des [**√©tapes standardis√©es**]{.orange}

![](https://astrakhan.fr/wp-content/uploads/2020/10/Data-Engineering.png)

[Source](https://astrakhan.fr/blog/formation-au-data-engineering-une-nouvelle-offre-dastrakhan/)


## Motivations

- Une analyse de donn√©es ou une cha√Æne de production font intervenir des [**√©tapes standardis√©es**]{.orange}

- Ces √©tapes peuvent √™tre formalis√©es sous forme d'un [**pipeline (*direct acyclic graph*)**]{.orange}

![](img/dag_argo.png)

[Source](https://medium.com/hashmapinc/building-ml-pipelines-8e27344a42d2)

## Motivations

- Une analyse de donn√©es ou une cha√Æne de production font intervenir des [**√©tapes standardis√©es**]{.orange}

::: {.incremental}
- Mod√©liser ces √©tapes sous forme de [**pipeline (*direct acyclic graph*)**]{.orange} a plusieurs avantages :
  - [**D√©couplage**]{.blue2} des diff√©rentes √©tapes
  - Facilite la [**planification**]{.blue2} du traitement
  - Facilite la [**prise en main**]{.blue2} du projet par un tiers
:::



## Le package `targets`

- `targets` est un *framework* de mod√©lisation de *pipelines* sp√©cifiquement d√©di√© aux projets `R`.

::: {.incremental}
- Deux objectifs majeurs : 
  1. [**R√©duire le co√ªt d'exp√©rimentation**]{.orange} en sauvegardant les r√©sultats interm√©diaires (***targets***)
  2. Garantir la [**reproductibilit√©**]{.orange} de la cha√Æne en tra√ßant les changements de ces ***targets***
:::

## M√©thode de travail avec `targets` {.smaller}

- On d√©veloppe dans des scripts :
    + Fonctions dans un ou plusieurs fichiers d√©di√©s
    + Cha√Æne de production dans un fichier `_targets.R`

. . .
    
- On g√®re l'ex√©cution du _pipeline_ directement dans la console
    + `tar_visnetwork()` pour inspecter la structure du _pipeline_
    + `tar_make` pour ex√©cuter la chaine de production
    
::: {.callout-note}

Quand on part du chaine de traitement dans un fichier d√©ja existant
(`script.R` par exemple), il faut faire la transition vers un fichier
`_targets.R` dont la structure est particuli√®re.

:::

## :one: Un projet minimaliste {.smaller}

- Structure de projet _opinionated_ :
    + ~~Long script `script.R`~~ `_targets.R`
    + Cha√Æne de production: suite d'appels √† des fonctions d√©finies dans `R/functions.R`

<br>

```
‚îú‚îÄ‚îÄ _targets.R
‚îú‚îÄ‚îÄ data
‚îÇ   ‚îú‚îÄ‚îÄ raw
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ data.csv
‚îú‚îÄ‚îÄ R
‚îÇ   ‚îî‚îÄ‚îÄ functions.R
```

. . .

<br>

- Nouveau fichier: `_targets.R`
    + Contr√¥le le comportement de notre chaine de traitement
    + Encha√Ænement d'√©tapes de transformation de donn√©es selon une syntaxe particuli√®re

## :two: Le fichier `_targets.R` {.smaller}

::: {.incremental}
- Le fichier `_targets.R` doit satisfaire plusieurs conditions :
  1. Charger le _package_ `targets`
  2. Charger dans l'environnement les fonctions n√©cessaires
  3. D√©clarer les _packages_ n√©cessaires aux diff√©rentes √©tapes
  4. D√©finir le *pipeline*.
:::

. . . 

```r
# _targets.R file
library(targets)
source("R/functions.R")
tar_option_set(packages = c("readr", "dplyr", "ggplot2"))
list(
  tar_target(file, "data.csv", format = "file"),
  tar_target(data, get_data(file)),
  tar_target(model, fit_model(data)),
  tar_target(plot, plot_model(model, data))
)
```

::: {.callout-note}
Les fonctions `get_data`, `fit_model` et `plot_model` sont d√©finies
dans üìÅ `R/functions.R`
:::

## :three: Inspecter le *pipeline*

- La fonction `tar_visnetwork` permet de visualiser le *pipeline*

![](img/pipeline.png){height="350" fig-align="center"}

## :three: Ex√©cuter le *pipeline* {.smaller}

- La fonction `tar_make` ex√©cute le *pipeline* d√©fini dans `_targets.R`

![](img/pipeline_run1.png){height="200" fig-align="center"}

- üí° Lors des ex√©cutions suivantes, `targets` saute automatiquement les √©tapes qui n'ont pas chang√©

![](img/pipeline_run2.png){height="150" fig-align="center"}

## Ressources suppl√©mentaires

- La [documentation officielle de `targets`](https://books.ropensci.org/targets/)

- La [fiche UtilitR d√©di√©e √† `targets`](https://www.book.utilitr.org/targets.html)


{{< include applications_r/_application5.qmd >}}



# VI- Publication reproductible

## Enjeux

- Produire des [**√©tudes reproductibles**]{.orange} en int√©grant le code et le texte dans un m√™me document

. . .

- La g√©n√©ration compl√®te de l'√©tude est contenue dans un [**unique projet**]{.orange}

. . .

- [**Limiter les risques d'erreurs**]{.orange} dues aux gestes manuels

. . .

- Gestion native de [**diff√©rents formats**]{.orange} pour le document final (`pdf`, `html`, `odt`, etc.)

## `R Markdown`

::: {.incremental}
- `R Markdown` est un *package* `R` qui permet de lier
  - Du [**texte**]{.orange} au format `Markdown`
  - Du [**code**]{.orange} `R` qui peut √™tre ex√©cut√© et dont les sorties peuvent √™tre int√©gr√©es au texte
:::

. . .

- [**Dissociation du fond et de la forme**]{.orange} du document

::: {.incremental}
- Un document est [**compil√©**]{.orange} en deux √©tapes
  - [***knit***]{.green2} : le package `knitr` transforme le texte et les sorties `R` en un document `Markdown` standard
  - [***convert***]{.green2} : le logiciel `pandoc` transforme le document `.md` en un format de sortie standard (`html`, `pdf`, etc.)
:::

## `Quarto`

- `Quarto` est le successeur de `R Markdown`

. . .

- `Quarto` supporte [**diff√©rents moteurs de calcul**]{.orange} (`knitr`, `Jupyter`, `Observable`..) ce qui le rend nativement [**multi-langage**]{.orange} (`R`, `Python`, `JavaScript`..)

. . .

- Le fonctionnement des deux syst√®mes reste tr√®s proche

## Anatomie d'un document reproductible

![](img/qmd.png){height="500" fig-align="center"}

## Ressources suppl√©mentaires

- La [documentation officielle de `R Markdown`](https://rmarkdown.rstudio.com/lesson-1.html)

- La [fiche `UtilitR` sur `R Markdown`](https://www.book.utilitr.org/rmarkdown.html)

- La [documentation officielle de `quarto`](https://quarto.org/)


{{< include applications_r/_application6.qmd >}}



# Conclusion

- Les [**bonnes pratiques**]{.blue2} favorisent la [**reproductibilit√©**]{.orange} et la [**r√©utilisation**]{.orange} des projets statistiques

. . .

- Des [**outils**]{.orange} permettent d'appliquer les [**bonnes pratiques**]{.blue2}

. . .

- Le [**co√ªt**]{.orange} est d'autant plus faible que l'on se place [**en amont du projet**]{.orange}

. . .

- Quel [**socle**]{.orange} de [**bonnes pratiques**]{.blue2} pour l'Insee ?
